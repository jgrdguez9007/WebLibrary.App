@model WebLibrary.App.Controllers.AdminController.AdminVm
@{
  ViewData["Title"] = "Panel de Ingesta";
}
<section class="space-y-8" x-data="{notice:''}">
  <!-- Intro -->
  <div class="rounded-2xl bg-gradient-to-br from-slate-50 to-white ring-1 ring-black/5 p-8">
    <h1 class="text-3xl font-bold tracking-tight">Subir y procesar PDF</h1>
    <p class="mt-2 text-slate-600 max-w-2xl text-sm">
      Carga un PDF, clasif√≠calo por <strong>categor√≠a</strong> y <strong>tipo</strong>. El sistema extrae texto/OCR, genera un
      <strong>JSON</strong> y lo deja listo para b√∫squeda. Tambi√©n puedes reconstruir el √≠ndice cuando lo necesites.
    </p>

    <!-- Acciones r√°pidas -->
    <div class="mt-5 flex flex-col gap-3 sm:flex-row sm:items-center">
      <!-- Buscador r√°pido -->
      <form action="/search" method="get" class="flex gap-2">
        <input name="q" placeholder="Buscar r√°pido en la biblioteca‚Ä¶"
               class="w-72 rounded-xl border border-slate-300 px-4 py-2 focus:ring-2 focus:ring-indigo-500" />
        <button class="rounded-xl bg-indigo-600 text-white px-4 py-2 hover:bg-indigo-700">Buscar</button>
      </form>

      <!-- Reconstruir √≠ndice (HTMX) -->
      <button
        class="rounded-xl border px-4 py-2 hover:bg-slate-50"
        hx-post="/admin/rebuild-index" hx-swap="none"
        hx-on::after-request="notice='√çndice reconstruido correctamente'">
        Reconstruir √≠ndice
      </button>

      <!-- Aviso -->
      <template x-if="notice">
        <span class="text-sm text-emerald-700 bg-emerald-50 border border-emerald-200 rounded-lg px-3 py-1"
              x-text="notice" x-init="setTimeout(()=>notice='',2500)"></span>
      </template>
    </div>
  </div>

  <!-- Stats -->
  <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
    <div class="rounded-xl bg-white p-5 shadow-sm ring-1 ring-black/5">
      <div class="text-2xl">üìÑ</div>
      <div class="mt-2 text-sm text-slate-500">PDFs subidos</div>
      <div class="text-2xl font-semibold">@Model.PdfCount</div>
    </div>
    <div class="rounded-xl bg-white p-5 shadow-sm ring-1 ring-black/5">
      <div class="text-2xl">üß©</div>
      <div class="mt-2 text-sm text-slate-500">JSON generados</div>
      <div class="text-2xl font-semibold">@Model.JsonCount</div>
    </div>
    <div class="rounded-xl bg-white p-5 shadow-sm ring-1 ring-black/5">
      <div class="text-2xl">üíæ</div>
      <div class="mt-2 text-sm text-slate-500">Tama√±o total</div>
      <div class="text-2xl font-semibold">@Model.TotalSizeMb MB</div>
    </div>
    <div class="rounded-xl bg-white p-5 shadow-sm ring-1 ring-black/5">
      <div class="text-2xl">‚è±Ô∏è</div>
      <div class="mt-2 text-sm text-slate-500">√öltimo procesado</div>
      <div class="text-lg font-medium">@Model.LastProcessed?.ToString("yyyy-MM-dd HH:mm") ?? "‚Äî"</div>
    </div>
  </div>

  <!-- Formulario de carga -->
  <div class="rounded-2xl bg-white shadow-sm ring-1 ring-black/5 p-8">
    <h2 class="text-xl font-semibold">Nuevo documento</h2>

    <form class="mt-6 space-y-5" method="post" action="/admin/upload-form" enctype="multipart/form-data" x-data="{cat:'leyes'}">
      <div class="grid gap-4 sm:grid-cols-3">
        <!-- Categor√≠a -->
        <div>
          <label class="text-sm font-medium">Categor√≠a</label>
          <select name="category" x-model="cat"
                  class="mt-1 w-full rounded-xl border border-slate-300 p-2">
            <option value="leyes">Leyes</option>
            <option value="documentos-internos">Documentos Internos</option>
            <option value="memorias-anuales">Memorias Anuales</option>
            <option value="estudios">Estudios</option>
            <option value="procedimientos">Procedimientos</option>
          </select>
        </div>

        <!-- Tipo -->
        <div>
          <label class="text-sm font-medium">Tipo</label>
          <select name="docType" class="mt-1 w-full rounded-xl border border-slate-300 p-2">
            <option value="">(general)</option>
            <option value="ley"         x-show="cat=='leyes'">Ley</option>
            <option value="decreto-ley" x-show="cat=='leyes'">Decreto-ley</option>
            <option value="decreto"     x-show="cat=='leyes'">Decreto</option>
            <option value="reglamento"  x-show="cat=='leyes'">Reglamento</option>
            <option value="resolucion"  x-show="cat=='leyes'">Resoluci√≥n</option>
          </select>
        </div>

        <!-- Archivo -->
        <div>
          <label class="text-sm font-medium">Archivo PDF</label>
          <input type="file" name="file" accept="application/pdf"
                 class="mt-1 block w-full rounded-xl border border-slate-300 p-2" />
        </div>
      </div>

      <button class="rounded-xl bg-indigo-600 text-white px-5 py-3 hover:bg-indigo-700 transition">
        Procesar PDF
      </button>

      <p class="text-xs text-slate-500">
        Alternativa: copia PDFs a <code>wwwroot/files</code> y llama
        <code>POST /admin/process-existing?file=Nombre.pdf</code>.
      </p>
    </form>
  </div>

  <!-- Recientes -->
  <div class="rounded-2xl bg-white shadow-sm ring-1 ring-black/5 p-6">
    <div class="flex items-center justify-between">
      <h2 class="text-xl font-semibold">Recientes</h2>
      <a href="/docs" class="text-sm text-indigo-600 hover:text-indigo-700">Ver todos ‚Ä∫</a>
    </div>
    @if (Model.Recent.Count == 0) {
      <p class="mt-3 text-sm text-slate-600">A√∫n no hay documentos procesados.</p>
    } else {
      <ul class="mt-4 divide-y">
        @foreach (var r in Model.Recent) {
          <li class="py-3 flex items-center justify-between gap-3">
            <div class="flex items-center gap-3">
              <div class="w-12 h-16 bg-slate-100 border rounded-md overflow-hidden grid place-items-center">
                <img src="@r.ThumbUrl" alt="Portada" class="max-h-full max-w-full object-contain" />
              </div>
              <div>
                <div class="font-medium line-clamp-1">@r.Title</div>
                <div class="text-xs text-slate-500">@r.Date?.ToString("yyyy-MM-dd HH:mm")</div>
              </div>
            </div>
            <div class="flex gap-2">
              @if(!string.IsNullOrEmpty(r.PdfUrl)){
                <a class="rounded-lg border px-3 py-1.5 text-sm hover:bg-slate-50" href="@r.PdfUrl" target="_blank">PDF</a>
              }
              <a class="rounded-lg border px-3 py-1.5 text-sm hover:bg-slate-50" href="@r.JsonUrl" target="_blank">JSON</a>
            </div>
          </li>
        }
      </ul>
    }
  </div>
</section>
